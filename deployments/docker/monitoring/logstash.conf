input {
  beats {
    port => 5044
  }
  
  # JSON logs from services
  tcp {
    port => 5000
    codec => json_lines
  }
  
  # Syslog input
  syslog {
    port => 5514
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }
  
  # Add service identification
  if [service] {
    mutate {
      add_tag => [ "medrex-service" ]
    }
  }
  
  # Parse audit logs
  if [audit] == true {
    mutate {
      add_tag => [ "audit-log" ]
    }
  }
  
  # Parse security logs
  if [security] == true {
    mutate {
      add_tag => [ "security-log" ]
    }
  }
  
  # Parse PHI access logs
  if [phi_access] == true {
    mutate {
      add_tag => [ "phi-access-log" ]
    }
  }
  
  # Parse blockchain logs
  if [blockchain] == true {
    mutate {
      add_tag => [ "blockchain-log" ]
    }
  }
  
  # Parse compliance logs
  if [compliance] == true {
    mutate {
      add_tag => [ "compliance-log" ]
    }
  }
  
  # Add timestamp if not present
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }
  
  # Geolocate IP addresses
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
  
  # Parse user agent
  if [user_agent] {
    useragent {
      source => "user_agent"
      target => "ua"
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "medrex-logs-%{+YYYY.MM.dd}"
    
    # Route different log types to different indices
    if "audit-log" in [tags] {
      index => "medrex-audit-%{+YYYY.MM.dd}"
    } else if "security-log" in [tags] {
      index => "medrex-security-%{+YYYY.MM.dd}"
    } else if "phi-access-log" in [tags] {
      index => "medrex-phi-access-%{+YYYY.MM.dd}"
    } else if "blockchain-log" in [tags] {
      index => "medrex-blockchain-%{+YYYY.MM.dd}"
    } else if "compliance-log" in [tags] {
      index => "medrex-compliance-%{+YYYY.MM.dd}"
    }
  }
  
  # Output to stdout for debugging
  stdout {
    codec => rubydebug
  }
}